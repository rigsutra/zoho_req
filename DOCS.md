# ZohoHR — Full Documentation

## Table of Contents

1. [Project Overview](#1-project-overview)
2. [Tech Stack](#2-tech-stack)
3. [Project Structure](#3-project-structure)
4. [Setup Guide](#4-setup-guide)
5. [Database Schema](#5-database-schema)
6. [Backend API Reference](#6-backend-api-reference)
7. [Frontend Architecture](#7-frontend-architecture)
8. [Authentication & Roles](#8-authentication--roles)
9. [Feature Details](#9-feature-details)
10. [Environment Variables](#10-environment-variables)

---

## 1. Project Overview

ZohoHR is a simplified clone of Zoho People — an HR management system with two portals:

- **Admin Portal** — Manage employees, monitor attendance, approve/reject leave requests
- **Employee Portal** — Check-in/out with geolocation, track time, apply for leaves, view team info

The app uses Convex for real-time data subscriptions, meaning all dashboards update instantly when data changes (e.g., when an admin approves a leave, the employee's balance updates live).

---

## 2. Tech Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Frontend | React 19 + TypeScript | UI framework |
| Build Tool | Vite 7 | Dev server and bundler |
| Backend/DB | Convex | Serverless database with real-time subscriptions |
| Auth | Clerk | Authentication with role management |
| Styling | Tailwind CSS 4 | Utility-first CSS framework |
| UI Components | Custom (shadcn/ui-inspired) | Button, Card, Dialog, Table, Tabs, etc. |
| Calendar | react-big-calendar | Leave calendar visualization |
| Date Utils | date-fns | Date manipulation and formatting |
| Icons | Lucide React | Icon library |

---

## 3. Project Structure

```
zoho_req/
├── .env.local                    # Environment variables (not committed)
├── .gitignore
├── index.html                    # Vite entry HTML
├── package.json
├── tsconfig.json                 # Root TS config (references app + node)
├── tsconfig.app.json             # App-specific TS config (src/)
├── tsconfig.node.json            # Node-specific TS config (vite.config.ts)
├── vite.config.ts                # Vite config with React, Tailwind, path aliases
├── ReadMe.md                     # Project overview
├── DOCS.md                       # This file
│
├── convex/                       # Convex backend
│   ├── tsconfig.json             # Convex-specific TS config
│   ├── schema.ts                 # Database schema (6 tables)
│   ├── auth.config.ts            # Clerk JWT issuer configuration
│   ├── http.ts                   # HTTP router for Clerk webhooks
│   ├── crons.ts                  # Scheduled jobs (yearly leave reset)
│   ├── helpers.ts                # Shared auth helpers
│   ├── users.ts                  # User sync and queries
│   ├── employees.ts              # Employee CRUD
│   ├── attendance.ts             # Check-in/out mutations and queries
│   ├── leaveTypes.ts             # Leave type configuration
│   ├── leaveBalances.ts          # Leave balance management
│   ├── leaves.ts                 # Leave request workflow
│   └── _generated/               # Auto-generated by Convex CLI (not committed)
│
├── src/
│   ├── main.tsx                  # App entry — ClerkProvider + ConvexProvider
│   ├── App.tsx                   # React Router configuration
│   ├── index.css                 # Tailwind imports + theme variables
│   ├── vite-env.d.ts             # Vite type declarations
│   │
│   ├── lib/
│   │   ├── utils.ts              # cn() utility for Tailwind class merging
│   │   └── date-utils.ts         # Date formatting and business day calculation
│   │
│   ├── hooks/
│   │   ├── useRole.ts            # Current user role hook
│   │   └── useGeolocation.ts     # Browser Geolocation API hook
│   │
│   ├── components/
│   │   ├── ui/                   # Reusable UI primitives
│   │   │   ├── avatar.tsx
│   │   │   ├── badge.tsx
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── input.tsx
│   │   │   ├── label.tsx
│   │   │   ├── select.tsx
│   │   │   ├── skeleton.tsx
│   │   │   ├── table.tsx
│   │   │   ├── tabs.tsx
│   │   │   ├── textarea.tsx
│   │   │   └── toast.tsx
│   │   │
│   │   └── layout/               # Layout components
│   │       ├── AdminLayout.tsx    # Admin shell (sidebar + header + outlet)
│   │       ├── EmployeeLayout.tsx # Employee shell (sidebar + header + outlet)
│   │       ├── Header.tsx         # Top bar with Clerk UserButton
│   │       ├── ProtectedRoute.tsx # Role-based route guard
│   │       └── Sidebar.tsx        # Navigation sidebar
│   │
│   └── pages/
│       ├── SignInPage.tsx         # Clerk sign-in form
│       ├── NotFoundPage.tsx       # 404 page
│       │
│       ├── admin/
│       │   ├── AdminDashboard.tsx     # Stats + pending leaves + today's attendance
│       │   ├── EmployeesPage.tsx      # Employee list with CRUD dialogs
│       │   ├── EmployeeDetailPage.tsx # Single employee profile + balances + attendance
│       │   ├── AttendancePage.tsx      # All attendance records by date
│       │   └── LeaveManagementPage.tsx # Approve/reject leave requests
│       │
│       └── employee/
│           ├── EmployeeHome.tsx       # Tabbed home (My Space / Team / Organization)
│           ├── LeaveTrackerPage.tsx    # Leave tabs (My Leaves / Balance / Team / Calendar)
│           ├── TimeTrackerPage.tsx     # Live timer + weekly/monthly stats
│           └── AttendancePage.tsx      # Personal attendance history
```

---

## 4. Setup Guide

### Prerequisites

- Node.js 18+
- npm or yarn
- A Clerk account (free tier works)
- A Convex account (free tier works)

### Step 1: Install Dependencies

```bash
cd zoho_req
npm install
```

### Step 2: Set Up Clerk

1. Go to [clerk.com](https://clerk.com) and sign up / log in.
2. Create a new application.
3. In the Clerk Dashboard, copy the **Publishable Key**.
4. Go to **JWT Templates** and create a Convex template:
   - Template name: `convex`
   - This auto-configures the issuer domain
5. Note the **Issuer Domain** (e.g., `https://your-app.clerk.accounts.dev`).
6. Go to **Webhooks** and create a webhook:
   - Endpoint URL: `<your-convex-deployment-url>/clerk-webhook` (you'll get this URL after Step 3)
   - Events to subscribe: `user.created`, `user.updated`, `user.deleted`

### Step 3: Set Up Convex

```bash
npx convex dev
```

This will:
- Prompt you to log in to Convex
- Create a new project (or link to an existing one)
- Auto-set `VITE_CONVEX_URL` in your `.env.local`
- Generate the `convex/_generated/` directory
- Push the schema and functions to your Convex deployment

After this, set environment variables in the **Convex Dashboard** (Settings → Environment Variables):
- `CLERK_JWT_ISSUER_DOMAIN` = your Clerk issuer domain URL

### Step 4: Configure .env.local

Your `.env.local` should look like:

```env
VITE_CONVEX_URL=https://your-deployment-123.convex.cloud
VITE_CLERK_PUBLISHABLE_KEY=pk_test_abc123...
```

### Step 5: Seed Default Leave Types

In the Convex Dashboard → Functions tab, run the `leaveTypes:seed` internal mutation. This creates 5 default leave types:

| Code | Name | Annual Balance | Paid | Carry Forward |
|------|------|---------------|------|---------------|
| CL | Casual Leave | 12 | Yes | No |
| SL | Sick Leave | 12 | Yes | No |
| EL | Earned Leave | 15 | Yes | Yes (max 10) |
| LOP | Loss of Pay | 0 | No | No |
| CO | Compensatory Off | 0 | Yes | No |

### Step 6: Bootstrap the First Admin

1. Start the app and sign in with Clerk.
2. Go to the Convex Dashboard → Data tab → `users` table.
3. Find your user record and change `role` from `"employee"` to `"admin"`.
4. Refresh the app — you'll now see the Admin Dashboard.

### Step 7: Start Development

```bash
# Terminal 1: Convex dev server (watches for schema/function changes)
npx convex dev

# Terminal 2: Vite dev server
npm run dev
```

Open `http://localhost:5173` in your browser.

---

## 5. Database Schema

### 5.1 `users`

Synced from Clerk via webhooks. Acts as the identity bridge.

| Field | Type | Description |
|-------|------|-------------|
| `clerkId` | string | Clerk user ID (`user_2abc...`) |
| `email` | string | User email |
| `firstName` | string | First name |
| `lastName` | string | Last name |
| `imageUrl` | string? | Profile picture URL |
| `role` | `"admin"` \| `"employee"` | User role |

**Indexes:** `by_clerkId`, `by_email`, `by_role`

### 5.2 `employees`

HR profile data linked to a user. Created by admin.

| Field | Type | Description |
|-------|------|-------------|
| `userId` | Id\<users\> | FK to users table |
| `employeeId` | string | Company employee code (e.g., `EMP-001`) |
| `department` | string | Department name |
| `designation` | string | Job title |
| `dateOfJoining` | string | ISO date (`2024-03-15`) |
| `phone` | string? | Phone number |
| `address` | string? | Address |
| `emergencyContact` | string? | Emergency contact |
| `managerId` | Id\<employees\>? | Reporting manager (self-referential FK) |
| `status` | `"active"` \| `"inactive"` \| `"terminated"` | Employment status |

**Indexes:** `by_userId`, `by_department`, `by_managerId`, `by_employeeId`, `by_status`

### 5.3 `attendance`

One record per employee per day. Created on check-in, updated on check-out.

| Field | Type | Description |
|-------|------|-------------|
| `employeeId` | Id\<employees\> | FK to employees |
| `date` | string | ISO date (`2024-03-15`) |
| `checkInTime` | string | ISO datetime of check-in |
| `checkOutTime` | string? | ISO datetime of check-out |
| `checkInLocation` | `{latitude, longitude, accuracy}` | GPS coordinates at check-in |
| `checkOutLocation` | `{latitude, longitude, accuracy}`? | GPS coordinates at check-out |
| `totalHours` | number? | Hours worked (calculated on check-out) |
| `status` | `"present"` \| `"half-day"` \| `"absent"` | Attendance status |
| `notes` | string? | Optional notes |

**Indexes:** `by_employeeId`, `by_date`, `by_employeeId_date`

### 5.4 `leaveTypes`

Configurable leave categories. Seeded once, managed by admin.

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Display name |
| `code` | string | Short code (CL, SL, EL, etc.) |
| `description` | string? | Description |
| `defaultBalance` | number | Annual allocation |
| `isPaid` | boolean | Whether leave is paid |
| `isActive` | boolean | Whether available for new requests |
| `carryForward` | boolean | Whether unused days carry to next year |
| `maxCarryForward` | number? | Maximum carry-forward limit |

**Indexes:** `by_code`, `by_isActive`

### 5.5 `leaveBalances`

One record per employee per leave type per year.

| Field | Type | Description |
|-------|------|-------------|
| `employeeId` | Id\<employees\> | FK to employees |
| `leaveTypeId` | Id\<leaveTypes\> | FK to leaveTypes |
| `year` | number | Calendar year (2026) |
| `totalAllocation` | number | Total days allocated |
| `used` | number | Days consumed |
| `carriedForward` | number | Days carried from previous year |

**Computed:** `available = totalAllocation + carriedForward - used`

**Indexes:** `by_employeeId_year`, `by_employeeId_leaveType_year`

### 5.6 `leaveRequests`

Each leave application creates one record.

| Field | Type | Description |
|-------|------|-------------|
| `employeeId` | Id\<employees\> | FK to employees |
| `leaveTypeId` | Id\<leaveTypes\> | FK to leaveTypes |
| `startDate` | string | Leave start date |
| `endDate` | string | Leave end date |
| `numberOfDays` | number | Business days count |
| `reason` | string | Leave reason |
| `status` | `"pending"` \| `"approved"` \| `"rejected"` \| `"cancelled"` | Request status |
| `appliedOn` | string | ISO datetime of submission |
| `reviewedBy` | Id\<users\>? | Admin who reviewed |
| `reviewedOn` | string? | ISO datetime of review |
| `reviewNotes` | string? | Admin's comment |

**Indexes:** `by_employeeId`, `by_status`, `by_employeeId_status`, `by_startDate`

---

## 6. Backend API Reference

### 6.1 Auth Helpers (`convex/helpers.ts`)

| Function | Returns | Description |
|----------|---------|-------------|
| `getCurrentUser(ctx)` | User doc | Gets authenticated user; throws if not signed in |
| `getCurrentEmployee(ctx)` | `{user, employee}` | Gets user + employee record; throws if not found |
| `requireAdmin(ctx)` | User doc | Gets user; throws if role is not `"admin"` |

### 6.2 Users (`convex/users.ts`)

| Function | Type | Auth | Description |
|----------|------|------|-------------|
| `upsertFromClerk` | internalMutation | Webhook only | Create/update user from Clerk webhook |
| `deleteFromClerk` | internalMutation | Webhook only | Delete user on Clerk deletion |
| `getMe` | query | Any signed-in | Get current user (returns null if not found) |
| `getMeWithEmployee` | query | Any signed-in | Get current user + employee record |
| `setRole` | mutation | Admin only | Change a user's role |
| `listAll` | query | Admin only | List all users |

### 6.3 Employees (`convex/employees.ts`)

| Function | Type | Auth | Description |
|----------|------|------|-------------|
| `listAll` | query | Admin | List all employees with user data |
| `listByStatus` | query | Admin | Filter employees by status |
| `getById` | query | Admin | Get single employee detail |
| `create` | mutation | Admin | Create employee + initialize leave balances |
| `update` | mutation | Admin | Update employee fields |
| `remove` | mutation | Admin | Soft-delete (set status to "terminated") |
| `getMyProfile` | query | Employee | Get own profile with manager info |
| `getTeamMembers` | query | Employee | Get same-department colleagues |
| `getAllDepartments` | query | Admin | List all unique department names |

### 6.4 Attendance (`convex/attendance.ts`)

| Function | Type | Auth | Args | Description |
|----------|------|------|------|-------------|
| `checkIn` | mutation | Employee | `{latitude, longitude, accuracy}` | Record check-in with location |
| `checkOut` | mutation | Employee | `{latitude, longitude, accuracy}` | Record check-out, calculate hours |
| `getTodayStatus` | query | Employee | — | Get today's attendance record |
| `getMyHistory` | query | Employee | `{startDate, endDate}` | Get attendance in date range |
| `getAllByDate` | query | Admin | `{date}` | Get all attendance for a date |
| `getByEmployee` | query | Admin | `{employeeId, startDate, endDate}` | Get specific employee's attendance |

### 6.5 Leave Types (`convex/leaveTypes.ts`)

| Function | Type | Auth | Description |
|----------|------|------|-------------|
| `listActive` | query | Any signed-in | List active leave types |
| `listAll` | query | Admin | List all leave types |
| `create` | mutation | Admin | Create new leave type |
| `seed` | internalMutation | Internal | Seed 5 default leave types |

### 6.6 Leave Balances (`convex/leaveBalances.ts`)

| Function | Type | Auth | Description |
|----------|------|------|-------------|
| `getMyBalances` | query | Employee | Get current year's leave balances |
| `getByEmployee` | query | Admin | Get specific employee's balances |
| `resetForNewYear` | internalMutation | Cron | Create new year balances with carry-forward |

### 6.7 Leave Requests (`convex/leaves.ts`)

| Function | Type | Auth | Description |
|----------|------|------|-------------|
| `apply` | mutation | Employee | Submit leave request (validates balance + overlap) |
| `cancel` | mutation | Employee | Cancel own pending request |
| `getMyRequests` | query | Employee | Get own leave requests for a year |
| `getPending` | query | Admin | Get all pending requests |
| `getAllRequests` | query | Admin | Get all requests (optionally filtered by status) |
| `approve` | mutation | Admin | Approve request + deduct balance |
| `reject` | mutation | Admin | Reject request |
| `getApprovedForCalendar` | query | Any signed-in | Get approved leaves in date range (for calendar) |
| `getTeamOnLeaveThisWeek` | query | Employee | Get same-department colleagues on leave this week |

### 6.8 Cron Jobs (`convex/crons.ts`)

| Schedule | Function | Description |
|----------|----------|-------------|
| `0 0 1 1 *` (Jan 1, midnight) | `leaveBalances.resetForNewYear` | Creates new year balances with carry-forward |

### 6.9 HTTP Routes (`convex/http.ts`)

| Method | Path | Description |
|--------|------|-------------|
| POST | `/clerk-webhook` | Handles Clerk `user.created`, `user.updated`, `user.deleted` events |

---

## 7. Frontend Architecture

### 7.1 Routing

```
/sign-in                  → SignInPage (public)
/                         → RootRedirect (redirects based on role)

/admin                    → AdminDashboard
/admin/employees          → EmployeesPage (CRUD)
/admin/employees/:id      → EmployeeDetailPage
/admin/attendance         → AttendancePage (by date)
/admin/leaves             → LeaveManagementPage (approve/reject)

/employee                 → EmployeeHome (tabs: My Space / Team / Organization)
/employee/leaves          → LeaveTrackerPage (tabs: My Leaves / Balance / Team / Calendar)
/employee/time-tracker    → TimeTrackerPage
/employee/attendance      → AttendancePage (personal history)
```

### 7.2 Provider Stack

```
ClerkProvider
  └── ConvexProviderWithClerk
        └── ToastProvider
              └── BrowserRouter
                    └── Routes
```

### 7.3 Route Protection

`ProtectedRoute` component:
1. Checks Clerk auth state (`isSignedIn`)
2. Fetches user role via `useQuery(api.users.getMe)`
3. Redirects to `/sign-in` if unauthenticated
4. Redirects to correct dashboard if role mismatch
5. Shows loading skeleton while resolving

### 7.4 Layout Structure

Both admin and employee layouts share the same pattern:

```
┌─────────────────────────────────────────────┐
│ Sidebar (fixed, 256px)  │  Header (sticky)  │
│                         │───────────────────│
│  - Nav links            │                   │
│  - Role-specific items  │  Page Content     │
│                         │  (via <Outlet />)  │
│                         │                   │
└─────────────────────────────────────────────┘
```

### 7.5 UI Components

All components are in `src/components/ui/` and follow shadcn/ui patterns:
- Accept `className` prop for style overrides
- Use `cn()` utility for conditional Tailwind classes
- Use `React.forwardRef` for DOM ref forwarding
- Use `class-variance-authority` for variant-based styling

### 7.6 Custom Hooks

**`useRole()`** — Returns `{ role, isAdmin, isEmployee, isLoading, user }`

**`useGeolocation()`** — Returns `{ getLocation, isLoading, error }`
- `getLocation()` returns a Promise of `{ latitude, longitude, accuracy }`
- Uses `navigator.geolocation.getCurrentPosition` with high accuracy
- Handles permission denied, unavailable, and timeout errors

---

## 8. Authentication & Roles

### 8.1 How It Works

1. **User signs up** via Clerk → Clerk webhook fires → `convex/http.ts` receives it → calls `users.upsertFromClerk` → user record created with `role: "employee"`

2. **Admin promotes user** → Admin Dashboard → calls `users.setRole` → changes role to `"admin"`

3. **Frontend protection** → `ProtectedRoute` checks `user.role` from Convex DB → redirects if unauthorized

4. **Backend protection** → Every Convex function calls `getCurrentUser()` or `requireAdmin()` → throws if unauthorized

### 8.2 Why Roles Are in the Database (Not JWT)

- Role changes take effect **immediately** (no JWT expiry delay)
- All authorization logic is in **one place** (Convex functions)
- Simpler than managing Clerk metadata + JWT claims

### 8.3 First Admin Bootstrap

Since all new users default to `role: "employee"`, the first admin must be promoted manually:
1. Sign in via Clerk
2. Open Convex Dashboard → Data → `users` table
3. Edit your record: change `role` to `"admin"`

---

## 9. Feature Details

### 9.1 Check-In / Check-Out with Geolocation

**Flow:**
1. Employee clicks "Check In" button
2. Browser's Geolocation API requests permission
3. GPS coordinates captured: `{ latitude, longitude, accuracy }`
4. Coordinates sent to `attendance.checkIn` mutation
5. Server validates no duplicate check-in for today (compound index)
6. Attendance record created with location data

**Check-Out** follows the same flow, additionally calculating `totalHours`:
- `totalHours = (checkOutTime - checkInTime) / 3600000`
- Status set to `"half-day"` if < 4 hours, otherwise `"present"`

**Requirements:**
- Location permission is **mandatory** — check-in is blocked if denied
- Location is captured at the moment of action, not continuously
- The `accuracy` field stores GPS accuracy in meters

### 9.2 Leave System

**Leave Application Flow:**
```
Employee fills form → Validates balance & overlap → Creates "pending" request
     ↓
Admin reviews
     ├── Approve → balance.used += numberOfDays → status = "approved"
     └── Reject → no balance change → status = "rejected"
```

**Business Day Calculation:**
- Uses `date-fns` `eachDayOfInterval` + `isWeekend` filter
- Calculated client-side, sent to server as `numberOfDays`

**Leave Balance Formula:**
```
available = totalAllocation + carriedForward - used
```

**Overlap Detection:**
- On application, checks all `pending` and `approved` leaves for the same employee
- Rejects if date ranges overlap

**Calendar View:**
- Uses `react-big-calendar` with `date-fns` localizer
- Queries approved leaves for the visible date range
- Color-coded by leave type: CL=blue, SL=red, EL=green, LOP=gray, CO=amber
- Supports month, week, and agenda views

**Team On Leave:**
- Filters approved leaves to current week + same department
- Shows on both Employee Home (Team tab) and Leave Tracker (Team tab)

### 9.3 Time Tracker

- Shows today's live timer (updates every minute while checked in)
- Calculates weekly and monthly totals from attendance records
- Displays average hours per day
- Visual bar chart for weekly breakdown

### 9.4 Admin Employee Management

- **Create:** Links a Clerk user to an employee profile, auto-initializes leave balances
- **Edit:** Update department, designation, phone, address, status
- **Deactivate:** Soft-delete — sets `status: "terminated"` (preserves history)
- **Detail View:** Shows profile info, leave balances, and monthly attendance

---

## 10. Environment Variables

### Frontend (`.env.local`)

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_CONVEX_URL` | Yes | Convex deployment URL (auto-set by `npx convex dev`) |
| `VITE_CLERK_PUBLISHABLE_KEY` | Yes | Clerk publishable key from dashboard |

### Convex Dashboard (Settings → Environment Variables)

| Variable | Required | Description |
|----------|----------|-------------|
| `CLERK_JWT_ISSUER_DOMAIN` | Yes | Clerk JWT issuer URL (e.g., `https://your-app.clerk.accounts.dev`) |

---

## npm Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `dev` | `vite` | Start Vite dev server |
| `build` | `tsc -b && vite build` | Type-check and build for production |
| `preview` | `vite preview` | Preview production build locally |
